using Moq.Sequences;
using Services;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Xml.Linq;
using Tests.Helpers;

namespace Tests
{
    public class NetworkServiceTests
    {
        private NetworkService<XElement> _service;

        [SetUp]
        public void SetUp()
        {
            _service = new NetworkService<XElement> (new Xml3270Translator());
        }

        [Test]
        public void Outbound_1Response_AllProtected()
        {
            var data = new byte[] { 0xf5, 0x42, 0x11, 0x40,
                0x40, 0x1d, 0x60, 0xc8, 0x85, 0x99, 0x83, 0xa4, 0x93, 0x85, 0xa2, 0x40, 0xe5, 0x85, 0x99, 0xa2,
                0x89, 0x96, 0x95, 0x40, 0x40, 0x7a, 0x11, 0x40, 0xd4, 0x1d, 0xe8, 0xf4, 0x4b, 0xf6, 0x4b, 0xf0,
                0x4b, 0xf1, 0xf0, 0xf9, 0xf4, 0xf1, 0x60, 0xe2, 0xc4, 0xd3, 0x60, 0x87, 0xf6, 0xf5, 0x83, 0xf9,
                0xf7, 0x86, 0x84, 0xf6, 0x11, 0xc1, 0x50, 0x1d, 0x60, 0xc8, 0x96, 0xa2, 0xa3, 0x40, 0x95, 0x81,
                0x94, 0x85, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7a, 0x11, 0xc1, 0xe4, 0x1d,
                0xe8, 0xc7, 0xc1, 0xe4, 0xc7, 0xc1, 0xd4, 0xc5, 0xd3, 0xc1, 0x11, 0xc2, 0x60, 0x1d, 0x60, 0xc8,
                0x96, 0xa2, 0xa3, 0x40, 0xd6, 0xe2, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
                0x40, 0x7a, 0x11, 0xc2, 0xf4, 0x1d, 0xe8, 0xe6, 0x89, 0x95, 0x84, 0x96, 0xa6, 0xa2, 0x60, 0xf6,
                0x4b, 0xf2, 0x4b, 0xf9, 0xf2, 0xf0, 0xf0, 0x40, 0x40, 0xd7, 0x99, 0x96, 0x86, 0x85, 0xa2, 0xa2,
                0x89, 0x96, 0x95, 0x81, 0x93, 0x40, 0xf6, 0xf4, 0x60, 0x82, 0x89, 0xa3, 0x11, 0xc3, 0xf0, 0x1d,
                0x60, 0xc8, 0x96, 0xa2, 0xa3, 0x40, 0xc1, 0x99, 0x83, 0x88, 0x89, 0xa3, 0x85, 0x83, 0xa3, 0xa4,
                0x99, 0x85, 0x40, 0x7a, 0x11, 0xc4, 0xc4, 0x1d, 0xe8, 0xc9, 0x95, 0xa3, 0x85, 0x93, 0x4d, 0xd9,
                0x5d, 0x40, 0xa7, 0xf6, 0xf4, 0x11, 0xc5, 0x40, 0x1d, 0x60, 0xd7, 0x99, 0x96, 0x83, 0x85, 0xa2,
                0xa2, 0x96, 0x99, 0xa2, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7a, 0x11, 0xc5, 0xd4,
                0x1d, 0xe8, 0xd3, 0xd7, 0x7e, 0xf1, 0xf2, 0x6b, 0x40, 0xc3, 0x96, 0x99, 0x85, 0xa2, 0x7e, 0xf6,
                0x6b, 0x40, 0xc3, 0xd7, 0xe4, 0xa2, 0x7e, 0xf1, 0x11, 0xc6, 0x50, 0x1d, 0x60, 0xd3, 0xd7, 0xc1,
                0xd9, 0x40, 0xd5, 0x81, 0x94, 0x85, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7a,
                0x11, 0xc6, 0xe4, 0x1d, 0xe8, 0xc8, 0xc5, 0xd9, 0xc3, 0xe4, 0xd3, 0xc5, 0xe2, 0x11, 0xc7, 0x60,
                0x1d, 0x60, 0xc4, 0x85, 0xa5, 0x89, 0x83, 0x85, 0x40, 0x95, 0xa4, 0x94, 0x82, 0x85, 0x99, 0x40,
                0x40, 0x40, 0x40, 0x40, 0x7a, 0x11, 0xc7, 0xf4, 0x1d, 0xe8, 0xf0, 0x7a, 0xf0, 0xf0, 0xc3, 0xf0,
                0x11, 0xc8, 0xf0, 0x1d, 0x60, 0xe2, 0xa4, 0x82, 0x83, 0x88, 0x81, 0x95, 0x95, 0x85, 0x93, 0x40,
                0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7a, 0x11, 0xc9, 0xc4, 0x1d, 0xe8, 0xf0, 0xf0, 0xf1,
                0xc1, 0x11, 0xc8, 0xf0, 0x1d, 0x60, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
                0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
                0x40, 0xe3, 0xe3, 0xe3, 0xe3, 0xe3, 0xe3, 0xe3, 0xe3, 0xe3, 0xe3, 0xe3, 0xe3, 0x40, 0x40, 0x40,
                0xd2, 0xd2, 0xd2, 0xd2, 0x40, 0x40, 0xd2, 0xd2, 0xd2, 0xd2, 0xd2, 0x40, 0x40, 0x40, 0x40, 0x40,
                0xf5, 0xf5, 0xf5, 0xf5, 0xf5, 0xf5, 0xf5, 0xf5, 0xf5, 0xf5, 0xf5, 0xf5, 0x11, 0x4a, 0x40, 0x1d,
                0x60, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
                0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xe3, 0xe3, 0x40, 0x40,
                0x40, 0xe3, 0xe3, 0x40, 0x40, 0x40, 0xe3, 0xe3, 0x40, 0x40, 0x40, 0x40, 0xd2, 0xd2, 0x40, 0x40,
                0x40, 0x40, 0xd2, 0xd2, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xf5, 0xf5, 0x11, 0x4b, 0x50,
                0x1d, 0x60, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
                0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xe3, 0xe3, 0x40,
                0x40, 0x40, 0xe3, 0xe3, 0x40, 0x40, 0x40, 0xe3, 0xe3, 0x40, 0x40, 0x40, 0x40, 0xd2, 0xd2, 0x40,
                0x40, 0x40, 0xd2, 0xd2, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xf5, 0xf5, 0x11, 0x4c,
                0x60, 0x1d, 0x60, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
                0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
                0x40, 0x40, 0x40, 0xe3, 0xe3, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xd2, 0xd2,
                0x40, 0x40, 0xd2, 0xd2, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xf5, 0xf5, 0x11,
                0x4d, 0xf0, 0x1d, 0x60, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xf4, 0x93, 0x40, 0x40,
                0x40, 0x40, 0x40, 0x40, 0x6d, 0x6b, 0x6b, 0x6b, 0x60, 0x60, 0x60, 0x6b, 0x6b, 0x6d, 0x40, 0x40,
                0x40, 0x40, 0x40, 0x40, 0xe3, 0xe3, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xd2,
                0xd2, 0x40, 0xd2, 0xd2, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xf5, 0xf5,
                0x40, 0x40, 0x40, 0x40, 0x40, 0x11, 0x4f, 0x40, 0x1d, 0x60, 0x40, 0xe9, 0xe9, 0xe9, 0xa9, 0xa9,
                0x40, 0x61, 0x6b, 0x7d, 0x4b, 0x60, 0x7d, 0x79, 0x7d, 0x40, 0x40, 0x40, 0x40, 0x60, 0x4b, 0x40,
                0x40, 0x5e, 0x60, 0x5e, 0x5e, 0x6b, 0x40, 0x40, 0x40, 0x40, 0xe3, 0xe3, 0x40, 0x40, 0x40, 0x40,
                0x40, 0x40, 0x40, 0x40, 0x40, 0xd2, 0xd2, 0xd2, 0xd2, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
                0x40, 0x40, 0x40, 0x40, 0xf5, 0xf5, 0xf5, 0xf5, 0xf5, 0xf5, 0xf5, 0xf5, 0xf5, 0xf5, 0xf5, 0x40,
                0x40, 0x40, 0x40, 0x11, 0x50, 0x50, 0x1d, 0x60, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xf4, 0x6b,
                0xf4, 0x60, 0x40, 0x40, 0x5d, 0x40, 0x5d, 0x60, 0x6b, 0x6d, 0x4b, 0x40, 0x6b, 0x4d, 0x40, 0x4d,
                0x40, 0x40, 0x7d, 0x7d, 0x60, 0x7d, 0x40, 0x40, 0xe3, 0xe3, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
                0x40, 0x40, 0x40, 0xd2, 0xd2, 0xd2, 0xd2, 0xd2, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
                0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xf5, 0xf5, 0x40, 0x40,
                0x40, 0x40, 0x40, 0x40, 0x11, 0xd1, 0x60, 0x1d, 0x60, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7d, 0x60,
                0x60, 0x60, 0x7d, 0x7d, 0x4d, 0x6d, 0x61, 0x60, 0x60, 0x7d, 0x40, 0x40, 0x79, 0x60, 0x7d, 0x5d,
                0x6d, 0x5d, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xe3, 0xe3, 0x40, 0x40, 0x40, 0x40, 0x40,
                0x40, 0x40, 0x40, 0x40, 0xd2, 0xd2, 0x40, 0x40, 0xd2, 0xd2, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
                0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xf5, 0xf5, 0x11,
                0xd2, 0xf0, 0x1d, 0x60, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
                0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
                0x40, 0x40, 0x40, 0x40, 0xe3, 0xe3, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xd2,
                0xd2, 0x40, 0x40, 0x40, 0xd2, 0xd2, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
                0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xf5, 0xf5, 0x11, 0xd4, 0x40, 0x1d, 0x60, 0x40,
                0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xe3, 0x88, 0x85, 0x40, 0xd4, 0xe5, 0xe2, 0x40, 0xf3, 0x4b,
                0xf8, 0x91, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xe3,
                0xe3, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xd2, 0xd2, 0x40, 0x40, 0x40, 0x40,
                0xd2, 0xd2, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
                0x40, 0x40, 0x40, 0xf5, 0xf5, 0x11, 0xd5, 0x50, 0x1d, 0x60, 0x40, 0x40, 0x40, 0x40, 0x40, 0xe3,
                0xa4, 0x99, 0x4d, 0x95, 0x5d, 0x92, 0x85, 0xa8, 0x40, 0xe2, 0xa8, 0xa2, 0xa3, 0x85, 0x94, 0x40,
                0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xe3, 0xe3, 0x40, 0x40, 0x40, 0x40,
                0x40, 0x40, 0x40, 0x40, 0x40, 0xd2, 0xd2, 0x40, 0x40, 0x40, 0x40, 0x40, 0xd2, 0xd2, 0x40, 0x40,
                0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xf5, 0xf5,
                0x11, 0xd6, 0x60, 0x1d, 0x60, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
                0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40,
                0x40, 0x40, 0x40, 0xe3, 0xe3, 0xe3, 0xe3, 0xe3, 0xe3, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xd2,
                0xd2, 0xd2, 0xd2, 0x40, 0x40, 0x40, 0x40, 0x40, 0xd2, 0xd2, 0xd2, 0x40, 0x40, 0x40, 0x40, 0xf5,
                0xf5, 0xf5, 0xf5, 0xf5, 0xf5, 0xf5, 0xf5, 0xf5, 0xf5, 0xf5, 0x11, 0xd7, 0xf0, 0x1d, 0x60, 0x11,
                0xd9, 0x40, 0x1d, 0x60, 0x40, 0x40, 0x40, 0x40, 0xe3, 0xd2, 0xf3, 0x40, 0x83, 0x99, 0x85, 0x81,
                0xa3, 0x85, 0x84, 0x40, 0x82, 0xa8, 0x40, 0x40, 0x40, 0xe5, 0x96, 0x93, 0x92, 0x85, 0x99, 0x40,
                0xc2, 0x81, 0x95, 0x84, 0x92, 0x85, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xa5, 0x96, 0x93,
                0x92, 0x85, 0x99, 0x7c, 0x82, 0x81, 0x95, 0x84, 0x92, 0x85, 0x4b, 0x96, 0x99, 0x87, 0x11, 0x5a,
                0x50, 0x1d, 0x60, 0x40, 0x40, 0x40, 0x40, 0xe3, 0xd2, 0xf4, 0x60, 0x40, 0xa4, 0x97, 0x84, 0x81,
                0xa3, 0x85, 0x40, 0x82, 0xa8, 0x40, 0x40, 0x40, 0xd1, 0xa4, 0x85, 0x99, 0x87, 0x85, 0x95, 0x40,
                0xe6, 0x89, 0x95, 0x92, 0x85, 0x93, 0x94, 0x81, 0x95, 0x95, 0x40, 0x40, 0x91, 0xa4, 0x85, 0x99,
                0x87, 0x85, 0x95, 0x4b, 0xa6, 0x89, 0x95, 0x92, 0x85, 0x93, 0x94, 0x81, 0x95, 0x95, 0x7c, 0x97,
                0x85, 0x82, 0x82, 0x93, 0x85, 0x60, 0x82, 0x85, 0x81, 0x83, 0x88, 0x4b, 0x83, 0x88, 0x11, 0x5b,
                0x60, 0x1d, 0x60, 0x40, 0x40, 0x40, 0x40, 0xe3, 0xd2, 0xf5, 0x40, 0x40, 0xa4, 0x97, 0x84, 0x81,
                0xa3, 0x85, 0x40, 0x82, 0xa8, 0x40, 0x40, 0x40, 0xd9, 0x96, 0x82, 0x40, 0xd7, 0x99, 0x89, 0x95,
                0xa2, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x97, 0x99, 0x89, 0x95,
                0xf0, 0xf0, 0xf9, 0xf6, 0x7c, 0x87, 0x94, 0x81, 0x89, 0x93, 0x4b, 0x83, 0x96, 0x94, 0x11, 0x5c,
                0xf0, 0x1d, 0x60, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0xa2, 0x85, 0x85, 0x40,
                0xe2, 0xe8, 0xe2, 0xf2, 0x4b, 0xd1, 0xc3, 0xd3, 0xd3, 0xc9, 0xc2, 0x4d, 0xc3, 0xd9, 0xc5, 0xc4,
                0xc9, 0xe3, 0xe2, 0x5d, 0x40, 0x86, 0x96, 0x99, 0x40, 0x83, 0x96, 0x94, 0x97, 0x93, 0x85, 0xa3,
                0x85, 0x40, 0x83, 0x99, 0x85, 0x84, 0x89, 0xa3, 0xa2, 0xff, 0xef };

            _service.CommandReady = true;
            var rowXml = new string[24];

            for (var i = 0; i < _service.Handlers.Length; i++)
            {
                var handler = _service.Handlers[i];
                var i1 = i;
                handler.RowUpdated += (sender, args) =>
                {
                    rowXml[i1] = args.Data.ToString();
                };
            }

            Assert.AreEqual((1503, 1895), _service.ProcessOutbound(data, 0, 0));
            foreach (var rowHandler in _service.Handlers)
            {
                rowHandler.Update();
            }

            Assert.AreEqual("<row>\r\n  <label col=\"1\">Hercules Version  :</label>\r\n  <label col=\"21\">4.6.0.10941-SDL-g65c97fd6</label>\r\n</row>", rowXml[0]);
            Assert.AreEqual("<row>\r\n  <label col=\"1\">Host name         :</label>\r\n  <label col=\"21\">GAUGAMELA</label>\r\n</row>", rowXml[1]);
            Assert.AreEqual("<row>\r\n  <label col=\"1\">Host OS           :</label>\r\n  <label col=\"21\">Windows-6.2.9200  Professional 64-bit</label>\r\n</row>", rowXml[2]);
            Assert.AreEqual("<row>\r\n  <label col=\"1\">Host Architecture :</label>\r\n  <label col=\"21\">Intel(R) x64</label>\r\n</row>", rowXml[3]);
            Assert.AreEqual("<row>\r\n  <label col=\"1\">Processors        :</label>\r\n  <label col=\"21\">LP=12, Cores=6, CPUs=1</label>\r\n</row>", rowXml[4]);
            Assert.AreEqual("<row>\r\n  <label col=\"1\">LPAR Name         :</label>\r\n  <label col=\"21\">HERCULES</label>\r\n</row>", rowXml[5]);
            Assert.AreEqual("<row>\r\n  <label col=\"1\">Device number     :</label>\r\n  <label col=\"21\">0:00C0</label>\r\n</row>", rowXml[6]);
            Assert.AreEqual("<row>\r\n  <label col=\"1\">                    </label>\r\n  <label col=\"21\">       TTTTTTTTTTTT   KKKK  KKKKK     555555555555</label>\r\n</row>", rowXml[7]);
            Assert.AreEqual("<row>\r\n  <label col=\"1\">                           TT   TT   TT    KK    KK       55</label>\r\n</row>", rowXml[8]);
            Assert.AreEqual("<row>\r\n  <label col=\"1\">                           TT   TT   TT    KK   KK        55</label>\r\n</row>", rowXml[9]);
            Assert.AreEqual("<row>\r\n  <label col=\"1\">                                TT         KK  KK         55</label>\r\n</row>", rowXml[10]);
            Assert.AreEqual("<row>\r\n  <label col=\"1\">        4l      _,,,---,,_      TT         KK KK          55     </label>\r\n</row>", rowXml[11]);
            Assert.AreEqual("<row>\r\n  <label col=\"1\"> ZZZzz /,'.-'`'    -.  ;-;;,    TT         KKKK           55555555555    </label>\r\n</row>", rowXml[12]);
            Assert.AreEqual("<row>\r\n  <label col=\"1\">      4,4-  ) )-,_. ,( (  ''-'  TT         KKKKK                    55      </label>\r\n</row>", rowXml[13]);
            Assert.AreEqual("<row>\r\n  <label col=\"1\">     '---''(_/--'  `-')_)       TT         KK  KK                   55</label>\r\n</row>", rowXml[14]);
            Assert.AreEqual("<row>\r\n  <label col=\"1\">                                TT         KK   KK                  55</label>\r\n</row>", rowXml[15]);
            Assert.AreEqual("<row>\r\n  <label col=\"1\">       The MVS 3.8j             TT         KK    KK                 55</label>\r\n</row>", rowXml[16]);
            Assert.AreEqual("<row>\r\n  <label col=\"1\">     Tur(n)key System           TT         KK     KK                55</label>\r\n</row>", rowXml[17]);
            Assert.AreEqual("<row>\r\n  <label col=\"1\">                              TTTTTT      KKKK     KKK    55555555555</label>\r\n</row>", rowXml[18]);
            Assert.AreEqual("<row />", rowXml[19]);
            Assert.AreEqual("<row>\r\n  <label col=\"1\">    TK3 created by   Volker Bandke       volker@bandke.org</label>\r\n</row>", rowXml[20]);
            Assert.AreEqual("<row>\r\n  <label col=\"1\">    TK4- update by   Juergen Winkelmann  juergen.winkelmann@pebble-beach.ch</label>\r\n</row>", rowXml[21]);
            Assert.AreEqual("<row>\r\n  <label col=\"1\">    TK5  update by   Rob Prins           prin0096@gmail.com</label>\r\n</row>", rowXml[22]);
            Assert.AreEqual("<row />", rowXml[23]);
        }

        //[Test]
        //public void Handshake()
        //{
        //    var willTerminalType = new byte[] { 0xff, 0xfb, 0x18 };
        //    var doTerminalType = new byte[] { 0xff, 0xfd, 0x18 };
        //    var sendTerminalType = new byte[] { 0xff, 0xfa, 0x18, 0x01, 0xff, 0xf0 };
        //    var heresTerminalType = new byte[] { 0xff, 0xfa, 0x18, 0x00, 0x49, 0x42, 0x4d, 0x2d, 0x33, 0x32, 0x37, 0x39, 0x2d, 0x32, 0x2d, 0x45, 0xff, 0xf0 };
        //    var willBinaryTransmission = new byte[] { 0xff, 0xfb, 0x00 };
        //    var doBinaryTransmission = new byte[] { 0xff, 0xfd, 0x00 };
        //    var willEndOfRecord = new byte[] { 0xff, 0xfb, 0x19 };
        //    var doEndOfRecord = new byte[] { 0xff, 0xfd, 0x19 };

        //    using (Sequence.Create())
        //    {
        //        Assert.AreEqual(willTerminalType, _service.ProcessOutbound(doTerminalType));
        //        Assert.AreEqual(heresTerminalType, _service.ProcessOutbound(sendTerminalType));
        //        Assert.AreEqual(doBinaryTransmission, _service.ProcessOutbound(willBinaryTransmission));
        //        Assert.AreEqual(willBinaryTransmission, _service.ProcessOutbound(doBinaryTransmission));
        //        Assert.AreEqual(doEndOfRecord, _service.ProcessOutbound(willEndOfRecord));
        //        Assert.AreEqual(willEndOfRecord, _service.ProcessOutbound(doEndOfRecord));
        //    }
        //}

        [Test]
        public void StartField()
        {
            var data = new byte[] { 0x1d, 0x60, 0xc8, 0x96, 0xa2, 0xa3 };
            Assert.AreEqual((2, 341), _service.OrderStartField(data, 0, 340));
            Assert.AreSame(_service.Handlers[4], _service.CurrentRow);
            Assert.AreEqual(21, _service.CurrentRow?.CurrentCol);
        }

        [Test]
        public void ModifyField()
        {
            var data = new byte[]
            {
                Orders.MODIFY_FIELD, 0xf3,
                Attributes.FOREGROUND_COLOR, Colors.BLUE,
                Attributes.FIELD, 0b01000100,
                Attributes.OUTLINE, 0b00000100
            };

            RowUpdateEventArgs<XElement> eventArgs = null;

            var expectedBuffer = new byte[80];
            expectedBuffer[68] = 0b01000100;

            var expectedAttr = new Dictionary<int, IDictionary<byte, byte>>()
            {
                [68] = new Dictionary<byte, byte>()
                {
                    [Attributes.FOREGROUND_COLOR] = Colors.BLUE,
                    [Attributes.OUTLINE] = 0b00000100,
                    [Attributes.FIELD] = 0b01000100
                }
            };

            var handler = _service.Handlers[2];
            var eventInvoked = false;
            handler.RowUpdated += (sender, args) =>
            {
                eventInvoked = true;
                eventArgs = args;
            };

            Assert.AreEqual((8, 229), _service.OrderModifyField(data, 0, 228));
            handler.Update();

            Assert.True(eventInvoked);
        }

        [Test]
        public void SetBufferAddress()
        {
            var data = new byte[] { 0x11, 0xc3, 0xe4, 0x1d, 0xf0, 0x28 };
            Assert.AreEqual((3, 228), _service.OrderSetBufferAddress(data, 0));
        }
    }
}
